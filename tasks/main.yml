---
# tasks file for netzwirt.http-haproxy

- name:  add haproxy apt repo for wheezy
  apt_repository: 
    repo: "deb http://httpredir.debian.org/debian wheezy-backports main" 
    state: present 
    update_cache: yes
  when: ansible_distribution_release == "wheezy"


- name: add haproxy apt repo
  apt_repository: 
    repo: "ppa:vbernat/haproxy-1.5" 
    state: present 
    update_cache: yes
  when: ansible_distribution_release == "trusty"


- name: update apt-cache
  apt: 
    update_cache: yes 
    cache_valid_time: 3600      


- name: install packages
  apt: 
    pkg: "{{ item }}" 
    state: latest
  with_items:
    - haproxy
    - socat
  when: ansible_os_family == 'Debian'


- name: enable init script
  replace: 
    dest: /etc/default/haproxy
    regexp: 'ENABLED=0'
    replace: 'ENABLED=1'


- name: create certs directory
  file: 
    path: /etc/haproxy/certs
    state: directory 
    mode: 0755 
    owner: root


- name: copy pem files
  copy:
    src: "{{haproxy_certs_lookup}}/{{item.key}}.pem"
    dest: "/etc/haproxy/certs/{{item.key}}.pem"
    owner: haproxy
    group: haproxy
  notify: 
  - restart haproxy
  when: item.value.https|default(haproxy_default_https)
  with_dict: "{{Â haproxy_domains }}"
  
  
- name: update config
  template: 
    src: haproxy.cfg.j2
    dest: /etc/haproxy/haproxy.cfg 
  notify: 
  - restart haproxy


# include poor mans server
- include: 'letsencrypt.yml'
  when: haproxy_letsencrypt_validation and haproxy_letsencrypt_install_service
